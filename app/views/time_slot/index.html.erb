<%= render :layout => '/shared/panel' do %>
  <% if flash[:notice] %>
    <div class="alert alert-info alert-dismissable", data-cy="alertMessage" role="alert">
      <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
      <h6 class="mb-0">
        <%= flash[:notice] %>
      </h6>
    </div>
  <% end %>
  <% if @appointment.present? && @appointment.start > Time.zone.now %>
    <div class="container">
      <div class="card">
        <div class="card-body">
          <% unless @appointment.active %>
            <div class="row">
              <div class="col">
                <div class="alert alert-danger" role="alert">
                  Seu agendamento foi suspenso. Favor entrar em contato com a Ubs.
                </div>
              </div>
            </div>
          <% end %>
          <div class="row">
            <div class="col" data-cy="currentAppointmentText">
              <h4>Seu agendamento atual é em:</h4>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <div class="row">
                <div class="col">
                  <strong>Data: </strong><%= ApplicationHelper.humanize_datetime(@appointment.start) %>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <strong>Nome: </strong><%= @appointment.patient.name %>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <strong>Unidade: </strong><%= @ubs.name %>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <strong>Endereço: </strong><%= @ubs.address %>
                </div>
              </div>

              <% if @appointment.second_dose? %>
                <div class="row">
                  <div class="col" data-cy="appliedVaccineName">
                    <strong>Vacina: </strong><%= @appointment.vaccine_name.capitalize %>
                  </div>
                </div>
              <% end %>
              <br/>

              <%= render "shared/required_documents" %>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col">
              <%= button_to "patients/edit", class: "btn btn-primary btn-block", data: { cy: "editPatientButton" }, method: :get do %>
                Alterar meus dados
              <% end %>
            </div>
              <div class="col">
              <%= button_to cancel_time_slot_path(appointment_id: @appointment.id), class: "btn btn-danger btn-block", method: :delete, data: { cy: "cancelAppointmentButton", confirm: "Seu horário será cancelado. Confirmar?" } do %>
                Cancelar meu agendamento
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="row">
      <div class="col">
        <h4 class="text-center" data-cy="noAppointmentYetText">Você não possui nenhum agendamento no momento</h4>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col text-center">
        <%= button_to "patients/edit", class: "btn btn-primary centered-button", data: { cy: "editPatientButton" }, method: :get do %>
          Alterar meus dados
        <% end %>
      </div>
    </div>

  <% end %>
  <hr>

  <br/>
  <% if flash[:alert] %>
    <div class="alert alert-danger alert-dismissable" role="alert">
      <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
      <h6 class="mb-0">
        <%= flash[:alert] %>
      </h6>
    </div>
  <% end %>

  <nav aria-label="Page navigation example">
    <ul class="pagination justify-content-center">
      <li class="page-item active <%= "disabled" if @gap_in_days < 1 %>">
        <a class="page-link" href="?gap_in_days=<%= @gap_in_days - 1 %>" tabindex="-1">&laquo; Dia anterior</a>
      </li>
      <li class="page-item active disabled">
        <a class="page-link" href="#">
          <%= ApplicationHelper.humanize_date(@current_day) %>
        </a>
      </li>
      <li class="page-item active <%= "disabled" if @gap_in_days >= TimeSlotController::SLOTS_WINDOW_IN_DAYS %>">
        <a class="page-link" href="?gap_in_days=<%= @gap_in_days + 1 %>" tabindex="-1">Próximo dia &raquo;</a>
      </li>
    </ul>
  </nav>
  
  <% if @time_slots.present? && @patient_can_schedule %>
    <div class="container mt-5">
      <div class="row">
        <div class="col">
          <h4>Agendamentos disponíveis:</h4>
          <% if @appointment.present? && @appointment.start > Time.zone.now %>
            <div class="alert alert-warning alert-dismissable" role="alert">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <h6 class="mb-0">
              Caso queira trocar a data de seu agendamento, selecione o dia e unidade, escolha um horário disponível e clique em <strong>Substituir</strong>.
            </h6>
          </div>
          <% end %>
          <div class="alert alert-info alert-dismissable" role="alert">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <h6 class="mb-0">
              <strong>Após escolher</strong> o local, dia e hora de seu agendamento e confirmar, <strong>entre novamente no site para verificar seu agendamento</strong>.
            </h6>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <% @time_slots.each do |ubs, slots| %>
            <div id=<%= "ubsId#{ubs.id}Accordion" %>>
              <div class="card">
                <div class="card-header" id=<%= "ubsId#{ubs.id}" %>>
                  <h5 class="mb-0">
                    <button class="btn btn-link" data-cy="ubsTimeSlots" data-toggle="collapse" data-target=<%= "#ubsControl#{ubs.id}" %> aria-expanded="true" aria-controls=<%= "ubsControl#{ubs.id}" %>>
                      <%= ubs.identifier %>
                    </button>
                  </h5>
                </div>
                <div id=<%= "ubsControl#{ubs.id}" %> class="collapse" aria-labelledby=<%= "ubsId#{ubs.id}" %> data-parent=<%= "#ubsId#{ubs.id}Accordion" %>>
                  <div class="card-body">
                    <div class="container">
                      <% slots.each do |slot| %>
                        <div class="row">
                          <div class="col align-middle">
                            Horário <br /> <%= ApplicationHelper.humanize_time(slot.start) %>
                          </div>
                          <div class="col text-right">
                            <%= button_to @appointment.present? ? 'Substituir' : 'Agendar', schedule_time_slot_path(start_time: slot.start, ubs_id: ubs.id), class: "btn btn-success", data: { cy: "ubsSlot#{slot.start}" } %>
                          </div>
                        </div>
                        <hr/>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
          <br/>
        </div>
      </div>
    </div>
  <% else %>
    <h4>Nenhuma vaga disponível no momento!</h4>
    <div class="alert alert-info alert-dismissable" role="alert">
      <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
      <h6 class="mb-0">
        Prezado usuário, no momento todas as vagas estão ocupadas ou você não está entre o grupo que pode fazer um novo agendamento.<br/>
      </h6>
    </div>
  <% end %>
<% end %>

